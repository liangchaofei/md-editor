# 拖拽单位优化：块级拖拽

## 问题分析

你的洞察非常正确！之前的实现有一个根本性的问题：

### 错误的拖拽单位

**之前：**
```
1. 项目 A  ← 拖拽这一项
2. 项目 B
3. 项目 C
```

拖拽单个列表项（li）会导致：
- 破坏列表结构
- 序号混乱
- 格式丢失

### 正确的拖拽单位

**现在：**
```
[整个有序列表]  ← 拖拽整个列表
1. 项目 A
2. 项目 B
3. 项目 C
```

拖拽整个列表容器（ol/ul）：
- ✅ 保持列表结构完整
- ✅ 序号自动正确
- ✅ 格式完全保持

---

## 修改内容

### 1. 识别正确的拖拽单位

```typescript
// DragHandle.tsx
const updateHandle = (blockElement: Element) => {
  // 如果是列表项，找到父列表
  let targetElement = blockElement
  if (blockElement.tagName === 'LI') {
    const parentList = blockElement.closest('ul, ol')
    if (parentList) {
      targetElement = parentList  // 使用父列表而不是列表项
    }
  }
  
  // 使用正确的拖拽单位
  const pos = editor.view.posAtDOM(targetElement as Node, 0)
  setCurrentPos(pos)
}
```

### 2. 更新块级元素选择器

```typescript
// 之前：包含 li
const blockElement = target.closest('p, h1, h2, h3, h4, h5, h6, li, pre, blockquote')

// 现在：使用 ul/ol 代替 li
const blockElement = target.closest('p, h1, h2, h3, h4, h5, h6, ul, ol, pre, blockquote')
```

---

## 拖拽单位对照表

| Markdown 语法 | HTML 元素 | 拖拽单位 | 说明 |
|--------------|-----------|---------|------|
| 段落 | `<p>` | `<p>` | 拖拽单个段落 |
| `# 标题` | `<h1>` | `<h1>` | 拖拽单个标题 |
| `## 标题` | `<h2>` | `<h2>` | 拖拽单个标题 |
| `1. 列表` | `<ol><li>` | `<ol>` | **拖拽整个列表** |
| `- 列表` | `<ul><li>` | `<ul>` | **拖拽整个列表** |
| ` ``` 代码` | `<pre>` | `<pre>` | 拖拽整个代码块 |
| `> 引用` | `<blockquote>` | `<blockquote>` | 拖拽整个引用块 |
| 表格 | `<table>` | `<table>` | 拖拽整个表格 |

---

## 使用示例

### 示例 1：拖拽有序列表

**文档内容：**
```markdown
段落 A

1. 项目 1
2. 项目 2
3. 项目 3

段落 B
```

**操作：**
1. 鼠标悬停在列表上（任意列表项）
2. 显示拖拽手柄（在整个列表左侧）
3. 拖动整个列表到"段落 A"之前

**结果：**
```markdown
1. 项目 1
2. 项目 2
3. 项目 3

段落 A
段落 B
```

✅ 整个列表移动
✅ 序号保持正确
✅ 格式完全保持

---

### 示例 2：拖拽无序列表

**文档内容：**
```markdown
段落 A

- 项目 A
- 项目 B
- 项目 C

段落 B
```

**操作：**
拖动整个列表到"段落 B"之后

**结果：**
```markdown
段落 A
段落 B

- 项目 A
- 项目 B
- 项目 C
```

✅ 整个列表移动
✅ 格式完全保持

---

### 示例 3：拖拽混合内容

**文档内容：**
```markdown
# 标题 1

段落 A

1. 有序列表 1
2. 有序列表 2

- 无序列表 A
- 无序列表 B

段落 B
```

**可以拖拽的单位：**
- `# 标题 1` - 单个标题
- `段落 A` - 单个段落
- `整个有序列表` - 包含所有项目
- `整个无序列表` - 包含所有项目
- `段落 B` - 单个段落

**不能单独拖拽：**
- ❌ 单个列表项（`1. 有序列表 1`）
- ❌ 单个列表项（`- 无序列表 A`）

---

## 技术原理

### 为什么这样更好？

#### 1. 符合 Markdown 语义

```markdown
# Markdown 中的列表是一个整体

1. 项目 1
2. 项目 2
3. 项目 3

# 不是三个独立的块
```

#### 2. 保持文档结构

```
Document
├── Paragraph
├── OrderedList        ← 这是一个块
│   ├── ListItem 1
│   ├── ListItem 2
│   └── ListItem 3
└── Paragraph
```

#### 3. 避免结构破坏

```
# 错误：拖拽单个列表项
1. 项目 1
2. 项目 2
[拖拽项目 2]
结果：列表被拆分，结构混乱 ❌

# 正确：拖拽整个列表
[拖拽整个列表]
结果：列表完整移动，结构清晰 ✅
```

---

## 对比 Notion

### Notion 的拖拽逻辑

Notion 也是按块级拖拽：
- 拖拽列表 → 拖拽整个列表
- 拖拽段落 → 拖拽单个段落
- 拖拽标题 → 拖拽单个标题

**但 Notion 有一个特殊功能：**
- 可以通过缩进来调整列表项层级
- 可以将列表项拖出列表变成段落

### 我们的实现

**当前版本：**
- ✅ 拖拽整个列表（与 Notion 一致）
- ❌ 不支持单独拖拽列表项

**未来可以增强：**
- 按住 Shift 拖拽列表项 → 拖拽单个项目
- 拖拽列表项到列表外 → 转换为段落
- 拖拽列表项到其他列表 → 合并列表

---

## 用户体验

### 优点

1. **更符合直觉**
   - 列表是一个整体
   - 拖拽整个列表更自然

2. **避免错误**
   - 不会破坏列表结构
   - 不会出现序号混乱

3. **操作简单**
   - 不需要选择特定的列表项
   - 悬停在任意列表项都能拖拽整个列表

### 可能的困惑

**问题：** 用户想拖拽单个列表项怎么办？

**解决方案：**
1. **方案 A：** 提供"拆分列表"功能
   - 右键菜单 → 拆分列表
   - 将一个列表拆分为多个

2. **方案 B：** 支持列表项编辑
   - 剪切列表项（Ctrl+X）
   - 粘贴到其他位置（Ctrl+V）

3. **方案 C：** 高级拖拽模式
   - 按住 Shift 拖拽 → 拖拽单个列表项
   - 普通拖拽 → 拖拽整个列表

**建议：** 先使用当前方案（拖拽整个列表），观察用户反馈，再决定是否需要增强。

---

## 测试场景

### 场景 1：拖拽有序列表

```markdown
段落 A

1. 项目 1
2. 项目 2
3. 项目 3

段落 B
```

**测试：** 拖拽列表到段落 B 之后

**预期：**
```markdown
段落 A
段落 B

1. 项目 1
2. 项目 2
3. 项目 3
```

✅ 整个列表移动
✅ 序号保持 1、2、3

---

### 场景 2：拖拽无序列表

```markdown
段落 A

- 项目 A
- 项目 B
- 项目 C

段落 B
```

**测试：** 拖拽列表到段落 A 之前

**预期：**
```markdown
- 项目 A
- 项目 B
- 项目 C

段落 A
段落 B
```

✅ 整个列表移动
✅ 格式保持

---

### 场景 3：多个列表

```markdown
1. 列表 A-1
2. 列表 A-2

段落

- 列表 B-1
- 列表 B-2
```

**测试：** 拖拽有序列表到无序列表之后

**预期：**
```markdown
段落

- 列表 B-1
- 列表 B-2

1. 列表 A-1
2. 列表 A-2
```

✅ 两个列表独立移动
✅ 不会合并

---

## 总结

### 核心改进

1. **正确的拖拽单位** - 拖拽整个列表而不是单个列表项
2. **符合 Markdown 语义** - 列表是一个整体
3. **避免结构破坏** - 不会出现序号混乱或格式丢失

### 实现方式

```typescript
// 关键代码
if (blockElement.tagName === 'LI') {
  const parentList = blockElement.closest('ul, ol')
  if (parentList) {
    targetElement = parentList  // 使用父列表
  }
}
```

### 用户体验

- ✅ 更符合直觉
- ✅ 避免错误
- ✅ 操作简单
- ⚠️ 不支持单独拖拽列表项（未来可以增强）

**现在可以测试了！拖拽列表时会拖拽整个列表，不会破坏结构。** 🎉
