# 第35章：编辑器体验优化计划

## 目标

对标 Notion 编辑器，优化 Tiptap 编辑器的用户体验。

## 当前问题

### 1. 拖拽问题
- **现象：** 拖拽有序列表后，序号丢失
- **原因：** 拖拽时只移动了文本内容，没有保持列表结构
- **影响：** 用户体验差，数据丢失

### 2. 缺少 Notion 的核心体验
- 块级操作不够流畅
- 缺少悬停效果
- 缺少快捷键提示
- 缺少平滑动画

## Notion 编辑器核心特性

### 1. 块级编辑
- 每个段落/标题/列表项都是一个独立的块
- 可以独立选择、移动、删除
- 块之间有清晰的边界

### 2. 拖拽体验
- 拖拽手柄始终可见（悬停时）
- 拖拽时显示插入位置指示器
- 拖拽保持块的完整结构
- 平滑的动画过渡

### 3. 交互细节
- 悬停时显示操作按钮
- 点击空白处自动聚焦
- 回车创建新块
- 删除空块时自动合并

### 4. 视觉反馈
- 选中块有明显的高亮
- 拖拽时有阴影效果
- 插入位置有蓝色指示线
- 操作有平滑动画

## 优化方案

### 阶段1：修复拖拽问题

#### 问题分析
当前拖拽实现可能存在的问题：
1. 只移动了文本节点，没有移动整个列表项节点
2. 没有正确处理列表的嵌套结构
3. 拖拽后没有重新计算序号

#### 解决方案
1. 使用 Tiptap 的 `NodeView` 正确处理块级拖拽
2. 拖拽时移动整个节点（包括所有属性）
3. 拖拽后触发列表重新渲染

### 阶段2：优化拖拽手柄

#### 当前问题
- 拖拽手柄可能不够明显
- 悬停效果不够流畅
- 缺少视觉反馈

#### 优化方案
1. 增大拖拽手柄的点击区域
2. 添加悬停动画效果
3. 拖拽时显示半透明预览
4. 添加插入位置指示线

### 阶段3：块级操作优化

#### 功能增强
1. **块选择**
   - 点击拖拽手柄选中整个块
   - 支持多块选择（Shift + 点击）
   - 选中状态有明显视觉反馈

2. **块操作菜单**
   - 悬停时显示操作按钮
   - 支持复制、删除、转换类型
   - 快捷键提示

3. **块转换**
   - 段落 ↔ 标题
   - 段落 ↔ 列表
   - 有序列表 ↔ 无序列表

### 阶段4：交互细节优化

#### 1. 键盘操作
- `Enter` - 创建新块
- `Backspace` - 删除空块并合并
- `Tab` - 增加缩进
- `Shift + Tab` - 减少缩进
- `Cmd/Ctrl + D` - 复制当前块
- `Cmd/Ctrl + Shift + ↑/↓` - 移动块

#### 2. 鼠标操作
- 点击空白处自动聚焦到最后
- 双击选中整个块
- 拖拽选择多个块

#### 3. 视觉反馈
- 悬停时显示拖拽手柄
- 选中时显示边框高亮
- 拖拽时显示半透明预览
- 插入位置显示蓝色指示线

### 阶段5：性能优化

#### 优化点
1. 虚拟滚动（长文档）
2. 防抖输入处理
3. 延迟加载图片
4. 优化重渲染

## 实施计划

### 第1步：修复拖拽问题（优先）
- 检查当前拖拽实现
- 修复有序列表拖拽
- 测试各种场景

### 第2步：优化拖拽手柄
- 改进视觉设计
- 添加悬停效果
- 添加拖拽预览

### 第3步：块级操作
- 实现块选择
- 添加操作菜单
- 支持块转换

### 第4步：交互优化
- 完善键盘快捷键
- 优化鼠标操作
- 添加视觉反馈

### 第5步：性能优化
- 性能分析
- 针对性优化
- 压力测试

## 技术栈

### 使用的库
- `@tiptap/react` - 核心编辑器
- `@tiptap/extension-drag-handle` - 拖拽手柄
- `@tiptap/pm` - ProseMirror 核心
- `framer-motion` - 动画效果（可选）

### 关键 API
- `NodeView` - 自定义节点渲染
- `Plugin` - 自定义插件
- `Decoration` - 装饰器（高亮、指示线）
- `Transaction` - 事务处理

## 参考资源

### Notion 编辑器特性
- 块级编辑
- 拖拽排序
- 斜杠命令
- 快捷键

### Tiptap 官方示例
- [Drag Handle](https://tiptap.dev/experiments/drag-handle)
- [Block Editor](https://tiptap.dev/experiments/block-editor)
- [Collaborative Editing](https://tiptap.dev/collaboration)

## 成功标准

### 功能完整性
- ✅ 拖拽不丢失格式
- ✅ 支持所有块类型
- ✅ 快捷键完善
- ✅ 操作流畅

### 用户体验
- ✅ 视觉反馈清晰
- ✅ 动画流畅自然
- ✅ 响应速度快
- ✅ 学习成本低

### 性能指标
- ✅ 首次渲染 < 100ms
- ✅ 输入延迟 < 16ms
- ✅ 拖拽流畅 60fps
- ✅ 支持 10000+ 块

## 下一步

开始实施第1步：修复拖拽问题
