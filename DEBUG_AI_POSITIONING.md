# AI 文本定位调试指南

## 问题描述
AI 对话式文档编辑功能中，AI 返回的 `target` 文本无法在编辑器中准确定位。

## 核心原理

### 文档格式
- 编辑器使用 **Markdown 格式** 存储内容
- AI 接收和返回的也是 **Markdown 格式**（包含 `#`、`*`、`-` 等标记）
- 定位流程：
  1. AI 在 Markdown 中定位目标文本
  2. 将 Markdown 位置转换为 ProseMirror 位置
  3. 在编辑器中标记

### 为什么使用 Markdown？
- 保留文档结构信息（标题级别、列表等）
- AI 能更准确理解文档层次
- 匹配更精确（例如：`## 标题` vs `标题`）

## 调试步骤

### 1. 打开浏览器开发者工具
- 按 `F12` 或 `Cmd+Option+I` (Mac) 打开开发者工具
- 切换到 **Console** 标签页

### 2. 测试 AI 编辑功能
1. 在编辑器中生成一些内容（例如："帮我写一份技术方案"）
2. 等待内容生成完成
3. 在 AI 对话框输入修改需求（例如："把第一章节标题改为'项目概述'"）
4. 点击发送

### 3. 查看控制台日志

#### 日志分组 1: AI 返回的数据
```
📄 发送给 AI 的 Markdown 内容（前500字符）: "## 一、项目概述\n\n..."
📝 收到结构化修改建议: {...}
📋 AI 返回的完整数据: {...}
🎯 第一个修改建议:
  - target: "## 四、技术方案响应"  // 注意包含 Markdown 标记
  - replacement: "## 四、涵盖技术领域内容"
  - description: "..."
📄 当前文档内容（前500字符）: "## 一、项目概述\n\n..."
```

**检查点：**
- `target` 是否包含 Markdown 标记（`##`、`*`、`-` 等）？
- 文档内容是否也是 Markdown 格式？
- 是否有空格、标点、换行的差异？

#### 日志分组 2: 文本定位过程
```
🔍 开始查找目标文本
  target: "## 四、技术方案响应"
  targetLength: 12
📄 文档格式: Markdown
📄 文档长度: 1234
🔍 文本定位调试
  📄 文档长度: 1234
  🎯 目标文本: "## 四、技术方案响应"
  📝 目标长度: 12
  📄 文档前200字符: "## 一、项目概述\n\n..."
  🔄 规范化后目标: "## 四、技术方案响应"
```

**检查点：**
- 文档格式是否为 Markdown？
- 目标文本是否包含 Markdown 标记？
- 规范化后的文本是什么样？

#### 日志分组 3: 匹配策略
系统会尝试 5 种匹配策略：

1. **策略1: 精确匹配**
   - 直接在文档中查找目标文本
   - 如果成功：`✅ 策略1: 精确匹配成功`
   - 如果失败：`❌ 策略1: 精确匹配失败`

2. **策略2: 规范化目标匹配**
   - 将目标文本规范化（去除多余空格）后在原文档中查找
   - 如果成功：`✅ 策略2: 规范化目标匹配成功`

3. **策略3: 双规范化匹配**
   - 将文档和目标都规范化后匹配
   - 如果成功：`✅ 策略3: 双规范化匹配成功`

4. **策略4: 去标点匹配**
   - 去除所有标点符号和空格后匹配
   - 如果成功：`✅ 策略4: 去标点匹配成功`

5. **策略5: 模糊匹配**
   - 使用相似度算法查找最相似的文本
   - 如果成功：`✅ 策略5: 模糊匹配成功`
   - 会显示相似度分数

**检查点：**
- 哪个策略成功了？
- 如果都失败了，查看最后的建议

### 4. 常见问题和解决方案

#### 问题 1: AI 返回的 target 缺少 Markdown 标记
**症状：**
```
🎯 目标文本: "四、技术方案响应"  // 缺少 ##
📄 文档内容: "## 四、技术方案响应"  // 有 ##
```

**解决方案：**
- 已在后端 Prompt 中强调必须包含 Markdown 标记
- 策略4（去标点匹配）会移除 Markdown 标记后匹配
- 如果仍然失败，需要进一步优化 Prompt

#### 问题 2: AI 返回的 target 包含额外字符
**症状：**
```
🎯 目标文本: "## 一、项目概述 "  // 注意末尾有空格
📄 文档内容: "## 一、项目概述"   // 没有空格
```

**解决方案：**
- 策略2 或策略3 应该能处理这种情况
- 如果仍然失败，需要改进后端 Prompt

#### 问题 2: 文档提取不正确
**症状：**
```
📄 文档长度: 0
或
📄 文档内容: ""
或
📄 文档格式: undefined
```

**解决方案：**
- 检查 `editor.storage.markdown.getMarkdown()` 是否正确工作
- 可能是编辑器还未初始化
- 确认 Markdown 扩展已正确配置

#### 问题 3: AI 返回的是纯文本而不是 Markdown
**症状：**
```
🎯 目标文本: "项目概述"  // 纯文本
📄 文档内容: "## 一、项目概述"  // Markdown
```

**解决方案：**
- 检查后端是否正确传递了 Markdown 内容
- 查看 `📄 发送给 AI 的 Markdown 内容` 日志
- 确认 AI 理解了 Markdown 格式要求

#### 问题 4: 特殊字符或编码问题
**症状：**
```
位置 5: " " (32) vs " " (160)  // 不同的空格字符
```

**解决方案：**
- 策略4（去标点匹配）应该能处理
- 可能需要添加字符规范化

### 5. 手动测试匹配算法

在浏览器控制台中运行：

```javascript
// 获取编辑器实例
const editor = window.__editor__

// 获取 Markdown 内容
const markdown = editor.storage.markdown.getMarkdown()
console.log('Markdown 内容:', markdown)

// 获取纯文本内容（用于对比）
const text = editor.getText()
console.log('纯文本内容:', text)

// 测试查找
const target = "## 四、技术方案响应"  // 注意包含 Markdown 标记
const index = markdown.indexOf(target)
console.log('查找结果:', index)

// 如果找不到，检查差异
if (index === -1) {
  console.log('Markdown 前100字符:', markdown.substring(0, 100))
  console.log('目标文本:', target)
  console.log('目标长度:', target.length)
  
  // 尝试不带标记的查找
  const targetWithoutMark = "四、技术方案响应"
  const index2 = markdown.indexOf(targetWithoutMark)
  console.log('不带标记的查找结果:', index2)
}
```

### 6. 报告问题

如果问题仍未解决，请提供以下信息：

1. **AI 返回的完整 JSON**（从 `📋 AI 返回的完整数据` 日志复制）
2. **文档内容**（从 `📄 当前文档内容` 日志复制）
3. **匹配策略结果**（哪些策略失败了）
4. **用户输入**（你输入的修改需求）

## 优化建议

### 短期优化
1. ✅ 使用 Markdown 格式传递给 AI
2. ✅ 改进后端 Prompt，强调包含 Markdown 标记
3. ✅ 添加详细的调试日志
4. ✅ 实现多种匹配策略（包括去 Markdown 标记匹配）
5. ⏳ 添加用户反馈机制（如果定位失败，提示用户）

### 长期优化
1. 使用 ProseMirror 的 `findChildren` API 遍历节点树
2. 实现更智能的文本提取（考虑节点边界）
3. 添加机器学习模型来改进文本匹配
4. 支持用户手动选择匹配位置

## 相关文件

- `client/src/utils/textMatcher.ts` - 文本匹配算法
- `client/src/hooks/useSuggestions.ts` - 建议管理和定位逻辑
- `client/src/components/editor/AIChatPanel.tsx` - AI 对话面板（日志输出）
- `server/src/routes/ai.ts` - 后端 API 和 Prompt
