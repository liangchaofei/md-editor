# AI 对话式编辑功能测试指南

## 测试步骤

### 1. 启动项目

```bash
# 终端 1: 启动服务器
cd server
pnpm dev

# 终端 2: 启动客户端
cd client
pnpm dev
```

### 2. 生成测试文档

1. 打开浏览器访问 `http://localhost:5173`
2. 创建一个新文档
3. 在 AI 对话框输入：

```
帮我写一份技术方案，包含以下章节：
一、项目概述
二、技术架构
三、实施方案
四、技术方案响应
```

4. 等待 AI 生成完整内容

### 3. 测试 AI 编辑功能

#### 测试用例 1: 修改标题

**输入：**
```
把第四章节标题改为"涵盖技术领域内容"
```

**预期结果：**
- AI 返回 JSON 格式的修改建议
- 编辑器中 "四、技术方案响应" 被蓝色高亮标记
- Hover 显示 tooltip，包含接受/拒绝按钮
- 点击接受后，标题变为 "四、涵盖技术领域内容"

**调试检查点：**
1. 打开浏览器控制台（F12）
2. 查看 `📝 收到结构化修改建议` 日志
3. 查看 `🔍 文本定位调试` 日志组
4. 确认哪个匹配策略成功了

#### 测试用例 2: 修改段落内容

**输入：**
```
把项目概述的第一段改为"本项目旨在构建一个现代化的企业级应用系统"
```

**预期结果：**
- AI 定位到项目概述章节的第一段
- 蓝色高亮标记该段落
- 可以接受或拒绝修改

#### 测试用例 3: 添加内容

**输入：**
```
在技术架构章节添加一段关于微服务架构的描述
```

**预期结果：**
- AI 可能会定位到技术架构章节的某个位置
- 或者返回错误（因为这是添加而不是替换）

### 4. 常见问题排查

#### 问题 1: 无法定位到文本

**症状：**
- 控制台显示 `❌ 所有匹配策略均失败`
- 编辑器中没有蓝色高亮

**排查步骤：**
1. 查看 `🎯 目标文本` 日志，复制 AI 返回的 target
2. 查看 `📄 当前文档内容` 日志，复制文档内容
3. 手动对比两者差异：
   - 是否有多余的空格？
   - 是否有不同的标点符号？
   - 是否有换行符差异？
4. 查看哪些匹配策略被尝试了
5. 查看 `💡 建议检查` 部分的提示

**解决方案：**
- 如果是 AI 返回的文本不准确，需要改进后端 Prompt
- 如果是匹配算法问题，需要优化 `textMatcher.ts`
- 如果是文档提取问题，检查 `editor.getText()` 的输出

#### 问题 2: 定位位置不准确

**症状：**
- 有蓝色高亮，但位置不对
- 高亮的文本不是目标文本

**排查步骤：**
1. 查看 `✅ 策略X: XXX匹配成功` 日志
2. 查看 `匹配文本:` 日志，确认实际匹配到的文本
3. 对比目标文本和匹配文本的差异

**解决方案：**
- 可能是模糊匹配的相似度阈值太低
- 可能需要调整匹配策略的优先级

#### 问题 3: AI 返回的不是 JSON

**症状：**
- 控制台显示 `解析 JSON 失败`
- 没有收到结构化建议

**排查步骤：**
1. 查看 `累积内容:` 日志
2. 检查 AI 返回的原始内容

**解决方案：**
- 改进后端 Prompt，强调必须返回纯 JSON
- 检查 AI 模型是否支持结构化输出

### 5. 性能测试

#### 测试大文档

1. 生成一个包含 10 个章节的长文档
2. 测试修改不同位置的内容
3. 观察定位速度和准确性

#### 测试多个修改建议

1. 输入："把所有章节标题都改为大写"
2. 观察是否能同时标记多个位置
3. 测试批量接受/拒绝

### 6. 边界情况测试

#### 测试特殊字符

- 包含 emoji 的文本
- 包含特殊标点的文本
- 包含代码块的文本

#### 测试空文档

- 在空文档中尝试编辑（应该失败）

#### 测试协同编辑

- 两个用户同时编辑
- 一个用户使用 AI 编辑，另一个用户手动编辑

## 调试技巧

### 1. 使用浏览器控制台

```javascript
// 获取编辑器实例
const editor = window.__editor__

// 获取文档内容
console.log(editor.getText())

// 获取 HTML 内容
console.log(editor.getHTML())

// 测试查找
const target = "四、技术方案响应"
const docText = editor.getText()
console.log('查找结果:', docText.indexOf(target))
```

### 2. 查看网络请求

1. 打开开发者工具的 Network 标签
2. 筛选 `/api/ai/edit` 请求
3. 查看请求体和响应

### 3. 断点调试

在以下位置设置断点：
- `client/src/utils/textMatcher.ts` 的 `findTextPosition` 函数
- `client/src/hooks/useSuggestions.ts` 的 `addSuggestion` 函数
- `client/src/components/editor/AIChatPanel.tsx` 的 `onStructured` 回调

## 预期改进

### 短期（当前版本）
- ✅ 详细的调试日志
- ✅ 多种匹配策略
- ✅ 错误提示
- ⏳ 用户友好的错误消息（Toast 通知）

### 中期
- 使用 ProseMirror 节点遍历
- 支持部分文本匹配
- 支持正则表达式匹配
- 添加匹配预览

### 长期
- AI 返回位置坐标而不是文本
- 使用语义理解而不是字符串匹配
- 支持智能合并冲突
- 支持撤销/重做历史

## 报告 Bug

如果发现问题，请提供：

1. **复现步骤**
2. **控制台日志**（完整的日志组）
3. **文档内容**（前 500 字符）
4. **AI 返回的 JSON**
5. **预期行为 vs 实际行为**

将这些信息发送给开发团队进行分析。
