# 第35章：拖拽功能测试指南

## 修复内容

### 1. DragHandle.tsx 改进
- ✅ 传递完整节点信息（位置、类型、大小）
- ✅ 添加拖拽开始日志
- ✅ 改进错误处理

### 2. DragAndDrop.ts 改进
- ✅ 支持完整节点数据和简单位置数据（兼容性）
- ✅ 改进位置计算（支持文本块和列表项）
- ✅ 特殊处理列表项拖拽（自动创建列表包裹）
- ✅ 根据移动方向优化操作顺序
- ✅ 添加详细日志用于调试
- ✅ 改进错误处理

## 测试步骤

### 测试前准备
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签页
3. 观察拖拽过程中的日志输出

### 测试用例

#### 用例1：普通段落拖拽
**测试内容：**
```
这是第一段
这是第二段
这是第三段
```

**操作：**
1. 鼠标悬停在"这是第二段"左侧，显示拖拽手柄（⋮⋮）
2. 拖拽手柄到"这是第一段"上方
3. 松开鼠标

**预期结果：**
```
这是第二段
这是第一段
这是第三段
```

**检查点：**
- ✅ 段落顺序正确
- ✅ 文本内容完整
- ✅ 格式保持不变

#### 用例2：标题拖拽
**测试内容：**
```
# 一级标题
## 二级标题
### 三级标题
```

**操作：**
1. 拖拽"二级标题"到"一级标题"上方

**预期结果：**
```
## 二级标题
# 一级标题
### 三级标题
```

**检查点：**
- ✅ 标题级别保持不变（#、##、###）
- ✅ 标题样式正确
- ✅ 顺序正确

#### 用例3：有序列表拖拽
**测试内容：**
```
1. 第一项
2. 第二项
3. 第三项
```

**操作：**
1. 拖拽"第二项"到"第一项"上方

**预期结果：**
```
1. 第二项
2. 第一项
3. 第三项
```

**检查点：**
- ✅ 序号自动更新（1、2、3）
- ✅ 列表项内容完整
- ✅ 仍然是有序列表

#### 用例4：无序列表拖拽
**测试内容：**
```
• 项目A
• 项目B
• 项目C
```

**操作：**
1. 拖拽"项目B"到"项目A"上方

**预期结果：**
```
• 项目B
• 项目A
• 项目C
```

**检查点：**
- ✅ 保持无序列表格式
- ✅ 项目符号正确显示
- ✅ 内容完整

#### 用例5：代码块拖拽
**测试内容：**
```
普通段落

```javascript
console.log('Hello')
```

另一个段落
```

**操作：**
1. 拖拽代码块到"普通段落"上方

**预期结果：**
```
```javascript
console.log('Hello')
```

普通段落
另一个段落
```

**检查点：**
- ✅ 代码块格式保持
- ✅ 语法高亮正常
- ✅ 代码内容完整

#### 用例6：列表项拖出列表
**测试内容：**
```
普通段落

1. 列表项1
2. 列表项2

另一个段落
```

**操作：**
1. 拖拽"列表项1"到"普通段落"和列表之间

**预期结果：**
```
普通段落

1. 列表项1

2. 列表项2

另一个段落
```

**检查点：**
- ✅ 列表项自动创建新列表
- ✅ 保持有序列表格式
- ✅ 序号从1开始

#### 用例7：跨类型拖拽
**测试内容：**
```
# 标题

普通段落

1. 列表项
```

**操作：**
1. 拖拽"标题"到"列表项"下方

**预期结果：**
```
普通段落

1. 列表项

# 标题
```

**检查点：**
- ✅ 所有格式保持
- ✅ 顺序正确
- ✅ 没有格式混乱

#### 用例8：嵌套列表拖拽
**测试内容：**
```
1. 父项1
   - 子项1
   - 子项2
2. 父项2
```

**操作：**
1. 拖拽"父项1"（包括子项）到"父项2"下方

**预期结果：**
```
1. 父项2
2. 父项1
   - 子项1
   - 子项2
```

**检查点：**
- ✅ 嵌套结构保持
- ✅ 子项跟随父项移动
- ✅ 序号自动更新

#### 用例9：向上拖拽
**测试内容：**
```
段落1
段落2
段落3
段落4
```

**操作：**
1. 拖拽"段落4"到"段落1"上方

**预期结果：**
```
段落4
段落1
段落2
段落3
```

**检查点：**
- ✅ 长距离拖拽正常
- ✅ 顺序正确
- ✅ 内容完整

#### 用例10：向下拖拽
**测试内容：**
```
段落1
段落2
段落3
段落4
```

**操作：**
1. 拖拽"段落1"到"段落4"下方

**预期结果：**
```
段落2
段落3
段落4
段落1
```

**检查点：**
- ✅ 长距离拖拽正常
- ✅ 顺序正确
- ✅ 内容完整

## 日志说明

### 正常拖拽日志
```
🎬 开始拖拽: { pos: 10, nodeType: "paragraph", nodeSize: 15 }
🎯 拖拽放置事件触发
📦 使用完整拖拽数据: { pos: 10, nodeType: "paragraph", nodeSize: 15 }
📍 拖拽起始位置: 10
📍 放置目标位置: 5
📦 拖拽节点类型: paragraph
📏 节点大小: 15
📍 插入到块之前
📍 实际插入位置: 5
✂️ 创建内容切片，节点类型: paragraph
⬆️ 向上移动，先插入
🗑️ 删除原位置: 25
✅ 拖拽完成
```

### 列表项拖拽日志
```
🎬 开始拖拽: { pos: 20, nodeType: "listItem", nodeSize: 12 }
🎯 拖拽放置事件触发
📦 使用完整拖拽数据: { pos: 20, nodeType: "listItem", nodeSize: 12 }
📍 拖拽起始位置: 20
📍 放置目标位置: 10
📦 拖拽节点类型: listItem
📏 节点大小: 12
📍 插入到列表项之前
📍 实际插入位置: 10
✂️ 创建内容切片，节点类型: listItem
📋 检测到列表项拖拽
✅ 目标位置在列表内
⬆️ 向上移动，先插入
🗑️ 删除原位置: 32
✅ 拖拽完成
```

### 列表项拖出列表日志
```
🎬 开始拖拽: { pos: 20, nodeType: "listItem", nodeSize: 12 }
🎯 拖拽放置事件触发
📦 使用完整拖拽数据: { pos: 20, nodeType: "listItem", nodeSize: 12 }
📍 拖拽起始位置: 20
📍 放置目标位置: 5
📦 拖拽节点类型: listItem
📏 节点大小: 12
📍 插入到块之后
📍 实际插入位置: 10
✂️ 创建内容切片，节点类型: listItem
📋 检测到列表项拖拽
⚠️ 目标位置不在列表内，需要创建新列表
📋 源列表类型: orderedList
⬆️ 向上移动，先插入
🗑️ 删除原位置: 32
✅ 列表项拖拽完成（创建新列表）
```

## 常见问题

### Q1: 拖拽后格式丢失
**可能原因：**
- 浏览器缓存问题
- 代码未正确加载

**解决方法：**
1. 硬刷新页面（Ctrl+Shift+R 或 Cmd+Shift+R）
2. 清除浏览器缓存
3. 检查控制台是否有错误

### Q2: 拖拽后位置不对
**可能原因：**
- 位置计算错误
- 节点边界判断问题

**解决方法：**
1. 查看控制台日志
2. 检查"实际插入位置"是否正确
3. 尝试拖拽到不同位置

### Q3: 列表项拖拽失败
**可能原因：**
- 列表结构复杂
- 嵌套层级过深

**解决方法：**
1. 查看控制台日志
2. 检查是否有错误信息
3. 简化列表结构测试

### Q4: 拖拽手柄不显示
**可能原因：**
- 鼠标位置不对
- CSS 样式问题

**解决方法：**
1. 鼠标移到块级元素左侧
2. 检查浏览器开发者工具中的元素
3. 确认 z-index 没有被覆盖

## 性能测试

### 大文档测试
1. 创建包含100+段落的文档
2. 测试拖拽响应速度
3. 观察是否有卡顿

### 复杂结构测试
1. 创建包含多层嵌套列表的文档
2. 测试拖拽嵌套项
3. 检查结构是否保持

## 下一步优化

### 体验优化
- [ ] 添加拖拽预览（显示拖拽内容）
- [ ] 添加插入位置指示线
- [ ] 添加平滑动画过渡
- [ ] 优化拖拽手柄显示逻辑

### 功能增强
- [ ] 支持多选拖拽
- [ ] 支持跨文档拖拽
- [ ] 支持拖拽到大纲视图
- [ ] 支持键盘快捷键移动

### 性能优化
- [ ] 减少不必要的重渲染
- [ ] 优化位置计算算法
- [ ] 添加拖拽节流
- [ ] 优化大文档性能

## 总结

本次修复解决了拖拽后格式丢失的核心问题：

1. **完整数据传递**：传递节点类型和大小，不只是位置
2. **正确的操作顺序**：根据移动方向选择先插入或先删除
3. **特殊处理列表**：自动创建列表包裹拖出的列表项
4. **准确的位置计算**：支持文本块和列表项的边界判断
5. **详细的日志**：方便调试和问题定位

测试时请按照上述用例逐一验证，确保所有场景都能正常工作。
