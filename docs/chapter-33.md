# ç¬¬33ç« ï¼šAI å¯¹è¯é¢æ¿ä¼˜åŒ–ä¸ Token ç»Ÿè®¡

æœ¬ç« å°†ä¼˜åŒ– AI å¯¹è¯é¢æ¿çš„ç”¨æˆ·ç•Œé¢ï¼Œç®€åŒ–å¸ƒå±€ï¼Œæ·»åŠ  Token ç»Ÿè®¡åŠŸèƒ½ï¼Œå¹¶ä¿®å¤é¦–é¡µè‡ªåŠ¨è§¦å‘é—®é¢˜ã€‚

## æœ¬ç« ç›®æ ‡

- ç®€åŒ– AI å¯¹è¯é¢æ¿å¤´éƒ¨ï¼Œç§»é™¤å†—ä½™å…ƒç´ 
- ä¼˜åŒ–è¾“å…¥æ¡†åŒºåŸŸå¸ƒå±€ï¼Œå°†æ¨¡å¼åˆ‡æ¢ç§»åˆ°è¾“å…¥æ¡†ä¸Šæ–¹
- æ·»åŠ æ¯æ¡æ¶ˆæ¯çš„ Token ç»Ÿè®¡æ˜¾ç¤ºï¼ˆè€—æ—¶ã€Token æ•°é‡ã€è´¹ç”¨ï¼‰
- ä¼˜åŒ–æ·±åº¦æ€è€ƒå¼€å…³çš„æ˜¾ç¤ºé€»è¾‘ï¼ˆæ ¹æ®æ¨¡å‹è‡ªåŠ¨æ˜¾ç¤º/éšè—ï¼‰
- ä¿®å¤é¦–é¡µè‡ªåŠ¨è§¦å‘ AI ç”Ÿæˆçš„é—®é¢˜

## ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### å¤´éƒ¨å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”® AI å†™ä½œåŠ©æ‰‹  æ­£åœ¨æ€è€ƒä¸­...                            â”‚
â”‚ [å…¨æ–‡|åˆ†æ®µ] [ğŸ“Š] [ğŸ—‘ï¸] [ğŸ›] [æ¨¡å‹â–¼] [âœ•]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŒ–åï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              [ğŸ—‘ï¸] [æ¨¡å‹â–¼] [âœ•]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¾“å…¥æ¡†å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥æ¡†...                                                â”‚
â”‚ [æ·±åº¦æ€è€ƒ] [å‘é€]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŒ–åï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [åˆ†æ­¥ç”Ÿæˆ] [æ·±åº¦æ€è€ƒ]                                    â”‚
â”‚ è¾“å…¥æ¡†...                                                â”‚
â”‚                                              [å‘é€]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®ç°æ­¥éª¤

### 1. æ›´æ–° Message ç±»å‹

é¦–å…ˆæ›´æ–°æ¶ˆæ¯ç±»å‹ï¼Œæ·»åŠ ç»Ÿè®¡ä¿¡æ¯å­—æ®µï¼š

```typescript
// client/src/types/message.ts
export interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  reasoning?: string  // æ€è€ƒè¿‡ç¨‹
  timestamp: number
  isStreaming?: boolean
  isGeneratingToEditor?: boolean
  stats?: {
    duration: number    // è€—æ—¶ï¼ˆç§’ï¼‰
    tokens: number      // Token æ•°é‡
    cost: number        // è´¹ç”¨ï¼ˆå…ƒï¼‰
  }
}
```

### 2. æ·»åŠ æ¨¡å‹å·¥å…·å‡½æ•°

åœ¨ `modelPreferences.ts` ä¸­æ·»åŠ é»˜è®¤æ¨¡å‹å’Œæ·±åº¦æ€è€ƒåˆ¤æ–­å‡½æ•°ï¼š

```typescript
// client/src/utils/modelPreferences.ts

// é»˜è®¤æ¨¡å‹
export const DEFAULT_MODEL = 'deepseek-chat'

/**
 * è·å–é»˜è®¤æ¨¡å‹
 */
export function getDefaultModel(): string {
  return loadGlobalModelPreference()
}

/**
 * åˆ¤æ–­æ¨¡å‹æ˜¯å¦æ”¯æŒæ·±åº¦æ€è€ƒ
 */
export function supportsDeepThink(model: string): boolean {
  return model.startsWith('deepseek-')
}
```

### 3. ç®€åŒ– AI å¯¹è¯é¢æ¿å¤´éƒ¨

ç§»é™¤å†—ä½™å…ƒç´ ï¼Œåªä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼š

```tsx
// client/src/components/editor/AIChatPanel.tsx

{/* å¤´éƒ¨ - ç®€åŒ–ç‰ˆ */}
<div className="flex items-center justify-end gap-2 border-b border-gray-200 px-4 py-2">
  {/* æ¸…ç©ºå†å²æŒ‰é’® */}
  {messages.length > 0 && (
    <button
      onClick={() => {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯å†å²å—ï¼Ÿ')) {
          clearHistory()
          setGeneratedContent('')
          clearOutline()
        }
      }}
      className="rounded-md p-1.5 text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition-colors"
      title="æ¸…ç©ºå¯¹è¯å†å²"
    >
      {/* åˆ é™¤å›¾æ ‡ */}
    </button>
  )}
  
  {/* æ¨¡å‹é€‰æ‹© */}
  <div className="relative group">
    <select
      value={model}
      onChange={(e) => {
        const newModel = e.target.value
        setModel(newModel)
        // å¦‚æœåˆ‡æ¢åˆ°ä¸æ”¯æŒæ·±åº¦æ€è€ƒçš„æ¨¡å‹ï¼Œè‡ªåŠ¨å…³é—­æ·±åº¦æ€è€ƒ
        if (!supportsDeepThink(newModel)) {
          setEnableDeepThink(false)
        }
      }}
      disabled={isThinking}
      className="appearance-none text-xs border border-gray-300 rounded-md pl-3 pr-8 py-1.5 bg-white"
    >
      {AVAILABLE_MODELS.map(m => (
        <option key={m.id} value={m.id}>{m.name}</option>
      ))}
    </select>
  </div>
  
  {/* å…³é—­æŒ‰é’® */}
  <button onClick={onClose}>âœ•</button>
</div>
```

**ç§»é™¤çš„å…ƒç´ ï¼š**
- âŒ "AI å†™ä½œåŠ©æ‰‹"æ ‡é¢˜
- âŒ "æ­£åœ¨æ€è€ƒä¸­..."çŠ¶æ€æ–‡å­—
- âŒ ç”Ÿæˆæ¨¡å¼åˆ‡æ¢æŒ‰é’®ï¼ˆç§»åˆ°è¾“å…¥æ¡†ä¸Šæ–¹ï¼‰
- âŒ Token ç»Ÿè®¡æŒ‰é’®ï¼ˆæ”¹ä¸ºæ¯æ¡æ¶ˆæ¯æ˜¾ç¤ºï¼‰
- âŒ è°ƒè¯•æŒ‰é’®

### 4. ä¼˜åŒ–è¾“å…¥æ¡†åŒºåŸŸ

å°†æ¨¡å¼åˆ‡æ¢å’Œæ·±åº¦æ€è€ƒå¼€å…³ç§»åˆ°è¾“å…¥æ¡†ä¸Šæ–¹ï¼š

```tsx
{/* è¾“å…¥æ¡† */}
<div className="border-t border-gray-200 p-4">
  <div className="space-y-3">
    {/* æ¨¡å¼é€‰æ‹©å’Œæ·±åº¦æ€è€ƒ */}
    <div className="flex items-center gap-2 px-1">
      {/* åˆ†æ­¥ç”ŸæˆæŒ‰é’® */}
      <button
        onClick={() => {
          if (generationMode === 'outline') {
            setGenerationMode('full')
            clearOutline()
          } else {
            setGenerationMode('outline')
          }
        }}
        disabled={isThinking || isGenerating}
        className={`flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-md ${
          generationMode === 'outline'
            ? 'bg-purple-100 text-purple-700 border border-purple-300'
            : 'bg-gray-100 text-gray-600 border border-gray-300'
        }`}
      >
        {generationMode === 'outline' && <span>âœ“</span>}
        <span>åˆ†æ­¥ç”Ÿæˆ</span>
      </button>

      {/* æ·±åº¦æ€è€ƒå¼€å…³ï¼ˆåªåœ¨æ”¯æŒçš„æ¨¡å‹ä¸‹æ˜¾ç¤ºï¼‰ */}
      {supportsDeepThink(model) && (
        <button
          onClick={() => setEnableDeepThink(!enableDeepThink)}
          disabled={isThinking || isGenerating}
          className={`flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-md ${
            enableDeepThink
              ? 'bg-blue-100 text-blue-700 border border-blue-300'
              : 'bg-gray-100 text-gray-600 border border-gray-300'
          }`}
        >
          {enableDeepThink && <span>âœ“</span>}
          <span>æ·±åº¦æ€è€ƒ</span>
        </button>
      )}
    </div>

    {/* è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’® */}
    <div className="flex gap-2">
      <textarea
        value={input}
        onChange={(e) => setInput(e.target.value)}
        onKeyDown={handleKeyDown}
        placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚..."
        disabled={isThinking || isGenerating}
        className="flex-1 resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm"
        rows={3}
      />
      <button
        onClick={handleSend}
        disabled={!input.trim() || isThinking || isGenerating}
        className="self-end rounded-lg bg-gradient-to-r from-purple-600 to-blue-600 px-4 py-2 text-sm font-medium text-white"
      >
        å‘é€
      </button>
    </div>
  </div>
</div>
```

### 5. æ·»åŠ  Token ç»Ÿè®¡åŠŸèƒ½

#### 5.1 åœ¨æ¶ˆæ¯å‘é€æ—¶è®°å½•å¼€å§‹æ—¶é—´

```typescript
const handleSend = async () => {
  if (!input.trim() || isThinking || !editor) return

  const userMessage: Message = {
    id: Date.now().toString(),
    role: 'user',
    content: input.trim(),
    timestamp: Date.now(),
  }

  addMessage(userMessage)
  const userInput = input.trim()
  setInput('')
  
  // è®°å½•å¼€å§‹æ—¶é—´ç”¨äºç»Ÿè®¡
  const startTime = Date.now()
  
  // ... åç»­é€»è¾‘
}
```

#### 5.2 åœ¨æ¶ˆæ¯å®Œæˆæ—¶è®¡ç®—ç»Ÿè®¡ä¿¡æ¯

```typescript
// å…¨æ–‡ç”Ÿæˆæ¨¡å¼
onComplete: () => {
  // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
  const duration = (Date.now() - startTime) / 1000
  const tokens = Math.ceil((userInput.length + accumulatedContent.length) / 2)
  const cost = tokens * 0.000001
  
  updateLastMessage(msg => ({
    ...msg,
    isStreaming: false,
    content: accumulatedContent,
    stats: { duration, tokens, cost }
  }))
}
```

#### 5.3 åœ¨ MessageItem ä¸­æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯

```tsx
{/* Token ç»Ÿè®¡ä¿¡æ¯ */}
{message.stats && (
  <div className="flex items-center gap-4 text-xs text-gray-500 pt-3 border-t">
    <div className="flex items-center gap-1">
      <span>â±ï¸</span>
      <span>{message.stats.duration.toFixed(1)}ç§’</span>
    </div>
    <div className="flex items-center gap-1">
      <span>ğŸ“Š</span>
      <span>{message.stats.tokens.toLocaleString()} tokens</span>
    </div>
    <div className="flex items-center gap-1">
      <span>ğŸ’°</span>
      <span>Â¥{message.stats.cost.toFixed(4)}</span>
    </div>
  </div>
)}
```

### 6. ä¿®å¤é¦–é¡µè‡ªåŠ¨è§¦å‘é—®é¢˜

è¿™æ˜¯æœ¬ç« æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚é—®é¢˜çš„æ ¹æºæ˜¯ç»„ä»¶é‡æ–°æ¸²æŸ“å¯¼è‡´ `useEffect` å¤šæ¬¡æ‰§è¡Œã€‚

#### 6.1 ä¿å­˜è·¯ç”±çŠ¶æ€

åœ¨ `EditorPage` ä¸­ä½¿ç”¨ `useRef` ä¿å­˜åˆå§‹çŠ¶æ€ï¼š

```typescript
// client/src/pages/EditorPage.tsx
function EditorPage() {
  const location = useLocation()
  const state = location.state as LocationState
  
  // ä½¿ç”¨ ref ä¿å­˜åˆå§‹çŠ¶æ€ï¼Œé˜²æ­¢åœ¨é‡æ–°æ¸²æŸ“æ—¶ä¸¢å¤±
  const initialStateRef = useRef<LocationState | null>(null)
  
  useEffect(() => {
    if (state && !initialStateRef.current) {
      initialStateRef.current = state
    }
  }, [state])
  
  const initialState = initialStateRef.current
  
  return (
    <Layout>
      <EditorContainer 
        initialPrompt={initialState?.initialPrompt}
        initialGenerationMode={initialState?.generationMode}
        initialEnableDeepThink={initialState?.enableDeepThink}
      />
    </Layout>
  )
}
```

#### 6.2 å®ç°è‡ªåŠ¨è§¦å‘é€»è¾‘

åœ¨ `AIChatPanel` ä¸­å®ç°è‡ªåŠ¨è§¦å‘ï¼š

```typescript
// ä¿å­˜å·²å¤„ç†çš„ prompt æ ‡è¯†ï¼Œé¿å…é‡å¤è§¦å‘
const processedKeyRef = useRef<string | null>(null)

// è‡ªåŠ¨è§¦å‘åˆå§‹æç¤ºè¯ï¼ˆåªè§¦å‘ä¸€æ¬¡ï¼‰
useEffect(() => {
  if (!initialPrompt) return
  
  // ç”Ÿæˆå”¯ä¸€æ ‡è¯†
  const currentKey = `${documentId}-${initialPrompt}`
  
  // å¦‚æœå·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
  if (processedKeyRef.current === currentKey) return
  
  // ç«‹å³æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆé˜²æ­¢é‡å¤æ‰§è¡Œï¼‰
  processedKeyRef.current = currentKey
  
  // ç­‰å¾…ç¼–è¾‘å™¨åˆå§‹åŒ–åè§¦å‘
  const checkAndTrigger = () => {
    if (editor && isOpen && input) {
      handleSend()
    } else {
      setTimeout(checkAndTrigger, 500)
    }
  }
  
  const timer = setTimeout(checkAndTrigger, 300)
  return () => clearTimeout(timer)
}, [initialPrompt, documentId]) // åªä¾èµ–è¿™ä¸¤ä¸ª
```

**å…³é”®ç‚¹ï¼š**

1. **ç«‹å³æ ‡è®°**ï¼šåœ¨æ£€æŸ¥æ¡ä»¶ä¹‹å‰å°±æ ‡è®°ä¸ºå·²å¤„ç†
2. **æœ€å°ä¾èµ–**ï¼šåªä¾èµ– `initialPrompt` å’Œ `documentId`
3. **è½®è¯¢æ£€æŸ¥**ï¼šä½¿ç”¨é€’å½’ `setTimeout` ç­‰å¾…ç¼–è¾‘å™¨åˆå§‹åŒ–
4. **å”¯ä¸€æ ‡è¯†**ï¼šä½¿ç”¨ `documentId + initialPrompt` ç»„åˆ

## æŠ€æœ¯è¦ç‚¹

### 1. Token ç»Ÿè®¡è®¡ç®—

```typescript
// ç²—ç•¥ä¼°ç®—ï¼ˆå®é™…åº”ä½¿ç”¨ tiktokenï¼‰
const tokens = Math.ceil((input.length + output.length) / 2)
const cost = tokens * 0.000001
```

### 2. æ·±åº¦æ€è€ƒé€»è¾‘

```typescript
// åˆ¤æ–­æ¨¡å‹æ˜¯å¦æ”¯æŒ
export function supportsDeepThink(model: string): boolean {
  return model.startsWith('deepseek-')
}

// åˆ‡æ¢æ¨¡å‹æ—¶è‡ªåŠ¨å…³é—­
if (!supportsDeepThink(newModel)) {
  setEnableDeepThink(false)
}

// åªåœ¨æ”¯æŒçš„æ¨¡å‹ä¸‹æ˜¾ç¤º
{supportsDeepThink(model) && <button>æ·±åº¦æ€è€ƒ</button>}
```

### 3. è‡ªåŠ¨è§¦å‘çš„é™·é˜±

**å¸¸è§é—®é¢˜ï¼š**
1. useEffect å¤šæ¬¡æ‰§è¡Œ
2. useRef å€¼ä¿ç•™
3. çŠ¶æ€åˆå§‹åŒ–é¡ºåº

**è§£å†³æ–¹æ¡ˆï¼š**
1. æœ€å°åŒ–ä¾èµ–é¡¹
2. ç«‹å³æ ‡è®°
3. è½®è¯¢ç­‰å¾…

## æµ‹è¯•è¦ç‚¹

- âœ… å¤´éƒ¨åŠŸèƒ½æ­£å¸¸
- âœ… æ¨¡å¼åˆ‡æ¢æ­£å¸¸
- âœ… æ·±åº¦æ€è€ƒå¼€å…³æ˜¾ç¤ºé€»è¾‘æ­£ç¡®
- âœ… Token ç»Ÿè®¡æ˜¾ç¤ºæ­£ç¡®
- âœ… è‡ªåŠ¨è§¦å‘å·¥ä½œæ­£å¸¸
- âœ… æµè§ˆå™¨å‰è¿›/åé€€ä¸é‡å¤è§¦å‘

## æ€»ç»“

æœ¬ç« å®Œæˆäº† AI å¯¹è¯é¢æ¿çš„å…¨é¢ä¼˜åŒ–ï¼š

1. **ç®€åŒ–ç•Œé¢**ï¼šç§»é™¤å†—ä½™å…ƒç´ 
2. **ä¼˜åŒ–å¸ƒå±€**ï¼šæ¨¡å¼åˆ‡æ¢ç§»åˆ°è¾“å…¥æ¡†ä¸Šæ–¹
3. **Token ç»Ÿè®¡**ï¼šä¸ºæ¯æ¡æ¶ˆæ¯æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
4. **æ™ºèƒ½æ˜¾ç¤º**ï¼šæ ¹æ®æ¨¡å‹è‡ªåŠ¨æ˜¾ç¤º/éšè—æ·±åº¦æ€è€ƒ
5. **è‡ªåŠ¨è§¦å‘**ï¼šä¿®å¤é¦–é¡µè‡ªåŠ¨è§¦å‘é—®é¢˜

è¿™äº›ä¼˜åŒ–ä½¿ AI å¯¹è¯é¢æ¿æ›´åŠ ç®€æ´ã€æ˜“ç”¨ï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒã€‚
