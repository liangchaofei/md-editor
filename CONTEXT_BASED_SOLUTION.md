# 上下文定位方案 - 最终解决方案

## 问题分析

你的例子完美展示了问题：
- 文档中有多个"基础入门"
- 关键词匹配会找到错误的位置
- 需要更精确的定位方式

## 解决方案：上下文定位

### 核心思想
**通过前后文唯一确定位置**，就像人类定位一样。

### 工作流程

#### 1. 用户输入
```
把"基础入门"改为"零基础入门学习"
```

#### 2. AI 分析文档并返回
```json
{
  "reasoning": "修改第一阶段标题",
  "changes": [{
    "contextBefore": "第一阶段：",
    "targetText": "基础入门",
    "contextAfter": "（1-2个月）",
    "replacement": "零基础入门学习",
    "description": "修改第一阶段标题"
  }]
}
```

#### 3. 前端精确定位
1. 在文档中查找："第一阶段：" + "基础入门" + "（1-2个月）"
2. 找到唯一匹配位置
3. 提取"基础入门"的精确位置
4. 标记并高亮

### 为什么这个方案可靠？

#### 问题对比

**之前的方案：**
- 只用关键词 "基础入门"
- 文档中有多个匹配
- 无法确定是哪一个

**现在的方案：**
- 使用 "第一阶段：基础入门（1-2个月）"
- 通过上下文唯一确定
- 精确定位到正确位置

### 匹配策略

#### 策略 1: 完整模式匹配（最精确）
```
查找: "第一阶段：基础入门（1-2个月）"
提取: "基础入门" 的位置
```

#### 策略 2: 前文定位
```
查找: "第一阶段："
验证: 后面是否是 "基础入门"
```

#### 策略 3: 后文定位
```
查找: "（1-2个月）"
验证: 前面是否是 "基础入门"
```

#### 策略 4: 规范化匹配
```
去除多余空格后匹配
```

### 优势

1. **精确性**：通过上下文唯一确定位置
2. **可靠性**：即使有多个相同文本也能准确定位
3. **智能性**：AI 理解语义，提供准确的上下文
4. **容错性**：多种匹配策略，提高成功率

### 示例对比

#### 你的例子

**文档内容：**
```
第一阶段：基础入门（1-2个月）
...
补充技能（2周）
CSS预处理器（Sass/Less）
移动端适配方案
PWA基础概念
```

**用户需求：**
"把第一阶段的'基础入门'改为'零基础入门学习'"

**AI 返回：**
```json
{
  "contextBefore": "第一阶段：",
  "targetText": "基础入门",
  "contextAfter": "（1-2个月）",
  "replacement": "零基础入门学习"
}
```

**定位结果：**
- ✅ 精确找到 "第一阶段：基础入门（1-2个月）"
- ✅ 提取 "基础入门" 的位置
- ✅ 不会匹配到 "PWA基础概念" 中的 "基础"

### 技术实现

#### 后端 Prompt
```
要求 AI 返回：
1. contextBefore: 目标文本前面的10-20个字符
2. targetText: 要替换的原文
3. contextAfter: 目标文本后面的10-20个字符
```

#### 前端匹配
```typescript
function findTextWithContext(
  docText: string,
  contextBefore: string,
  targetText: string,
  contextAfter: string
): { from: number; to: number } | null
```

### 测试方法

1. 生成包含重复文本的文档
2. 输入修改需求，明确指定是哪一个
3. 查看控制台日志：
   ```
   🎯 上下文精确定位
   ⬅️ 前文: 第一阶段：
   🎯 目标: 基础入门
   ➡️ 后文: （1-2个月）
   ✅ 精确匹配成功
   ```

### 预期效果

- ✅ 准确定位到正确的"基础入门"
- ✅ 不会误匹配其他位置
- ✅ 蓝色高亮显示
- ✅ 点击接受后正确替换

## 为什么之前的方案失败？

1. **关键词方案**：关键词不够唯一，匹配到多个位置
2. **精确文本方案**：AI 难以逐字复制，容易有细微差异
3. **智能匹配方案**：匹配到第一个出现的位置，不一定是用户想要的

## 这个方案为什么成功？

1. **语义理解**：AI 理解用户意图，知道是"第一阶段"的标题
2. **上下文提供**：AI 提供足够的上下文信息
3. **精确定位**：前端通过上下文唯一确定位置
4. **容错机制**：多种匹配策略，提高成功率

## 总结

这是一个**人类思维**的定位方式：
- 人类不会只说"把基础入门改掉"
- 人类会说"把第一阶段的基础入门改掉"
- 通过上下文明确指定位置

现在 AI 也这样做了！
