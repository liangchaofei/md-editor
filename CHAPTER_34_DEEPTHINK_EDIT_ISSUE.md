# æ·±åº¦æ€è€ƒæ¨¡å¼ä¸‹ç¼–è¾‘åŠŸèƒ½é—®é¢˜

## é—®é¢˜æè¿°

**ç°è±¡ï¼š**
- å¼€å¯æ·±åº¦æ€è€ƒï¼ˆä½¿ç”¨ deepseek-reasoner æ¨¡å‹ï¼‰
- é€šè¿‡å¯¹è¯æ”¹å†™æ­£æ–‡å†…å®¹
- AI æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹åï¼Œæ²¡æœ‰æ‰§è¡Œæ”¹å†™
- å…³é—­æ·±åº¦æ€è€ƒï¼ˆä½¿ç”¨ deepseek-chat æ¨¡å‹ï¼‰åˆ™æ­£å¸¸

## é—®é¢˜åˆ†æ

### å¯èƒ½çš„åŸå› 

1. **reasoner æ¨¡å‹è¿”å›æ ¼å¼ä¸åŒ**
   - reasoner æ¨¡å‹å…ˆè¾“å‡º `reasoning_content`ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰
   - ç„¶åè¾“å‡º `content`ï¼ˆæ­£æ–‡å†…å®¹ï¼‰
   - å¯èƒ½æ­£æ–‡å†…å®¹æ ¼å¼ä¸ chat æ¨¡å‹ä¸åŒ

2. **JSON è§£æé—®é¢˜**
   - reasoner æ¨¡å‹å¯èƒ½åœ¨æ€è€ƒè¿‡ç¨‹ä¸­å°±åŒ…å«äº†éƒ¨åˆ† JSON
   - æˆ–è€…æ­£æ–‡å†…å®¹è¢«åˆ†æ•£åœ¨å¤šä¸ª chunk ä¸­
   - å¯¼è‡´æœ€ç»ˆç´¯ç§¯çš„å†…å®¹ä¸æ˜¯å®Œæ•´çš„ JSON

3. **System Prompt ç†è§£é—®é¢˜**
   - reasoner æ¨¡å‹å¯èƒ½å¯¹ system prompt çš„ç†è§£ä¸ chat æ¨¡å‹ä¸åŒ
   - å¯èƒ½éœ€è¦è°ƒæ•´ prompt ä»¥é€‚é… reasoner æ¨¡å‹

## è°ƒè¯•æ­¥éª¤

### 1. æ·»åŠ æœåŠ¡ç«¯æ—¥å¿—

å·²åœ¨ `server/src/routes/ai.ts` ä¸­æ·»åŠ æ—¥å¿—ï¼š

```typescript
if (parsed.type === 'reasoning') {
  console.log('ğŸ’­ æ”¶åˆ°æ€è€ƒè¿‡ç¨‹ï¼ˆå‰50å­—ç¬¦ï¼‰:', parsed.content.substring(0, 50))
  ctx.res.write(`data: ${chunk}\n\n`)
} else if (parsed.type === 'content') {
  accumulatedContent += parsed.content
  console.log('ğŸ“ ç´¯ç§¯å†…å®¹ï¼ˆå‰50å­—ç¬¦ï¼‰:', accumulatedContent.substring(0, 50))
  ctx.res.write(`data: ${chunk}\n\n`)
}

console.log('âœ… æµå¼è¾“å‡ºå®Œæˆï¼Œç´¯ç§¯å†…å®¹é•¿åº¦:', accumulatedContent.length)
console.log('ğŸ“„ ç´¯ç§¯å†…å®¹ï¼ˆå‰200å­—ç¬¦ï¼‰:', accumulatedContent.substring(0, 200))
```

### 2. æµ‹è¯•æ­¥éª¤

1. å¼€å¯æ·±åº¦æ€è€ƒ
2. ç”Ÿæˆä¸€ç¯‡æ–‡æ¡£
3. è¾“å…¥"æŠŠæ ‡é¢˜æ”¹æˆxxx"
4. æŸ¥çœ‹æœåŠ¡ç«¯æ§åˆ¶å°æ—¥å¿—ï¼š
   - æ˜¯å¦æ”¶åˆ°æ€è€ƒè¿‡ç¨‹ï¼Ÿ
   - æ˜¯å¦æ”¶åˆ°æ­£æ–‡å†…å®¹ï¼Ÿ
   - ç´¯ç§¯å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ
   - æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ JSONï¼Ÿ

### 3. é¢„æœŸæ—¥å¿—è¾“å‡º

**æ­£å¸¸æƒ…å†µï¼ˆchat æ¨¡å‹ï¼‰ï¼š**
```
ğŸ“ ç´¯ç§¯å†…å®¹ï¼ˆå‰50å­—ç¬¦ï¼‰: ```json
{
  "reasoning": "ç”¨æˆ·æƒ³ä¿®æ”¹æ ‡é¢˜",
  "changes": [
âœ… æµå¼è¾“å‡ºå®Œæˆï¼Œç´¯ç§¯å†…å®¹é•¿åº¦: 250
```

**å¼‚å¸¸æƒ…å†µï¼ˆreasoner æ¨¡å‹ï¼‰ï¼š**
```
ğŸ’­ æ”¶åˆ°æ€è€ƒè¿‡ç¨‹ï¼ˆå‰50å­—ç¬¦ï¼‰: ç”¨æˆ·æƒ³è¦ä¿®æ”¹æ–‡æ¡£çš„æ ‡é¢˜éƒ¨åˆ†...
ğŸ“ ç´¯ç§¯å†…å®¹ï¼ˆå‰50å­—ç¬¦ï¼‰: ï¼ˆå¯èƒ½ä¸ºç©ºæˆ–ä¸å®Œæ•´ï¼‰
âœ… æµå¼è¾“å‡ºå®Œæˆï¼Œç´¯ç§¯å†…å®¹é•¿åº¦: 0
```

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç¼–è¾‘æ¨¡å¼å¼ºåˆ¶ä½¿ç”¨ chat æ¨¡å‹

åœ¨ `useChatLogic.ts` ä¸­ï¼Œç¼–è¾‘æ¨¡å¼ä¸‹å¼ºåˆ¶ä½¿ç”¨ chat æ¨¡å‹ï¼š

```typescript
// å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¼ºåˆ¶ä½¿ç”¨ chat æ¨¡å‹
if (isEditMode) {
  console.log('ğŸ”§ ç¼–è¾‘æ¨¡å¼ï¼šä¿®æ”¹ç°æœ‰å†…å®¹')
  
  // ç¼–è¾‘æ¨¡å¼ä¸‹å¼ºåˆ¶ä½¿ç”¨ chat æ¨¡å‹ï¼Œå› ä¸º reasoner æ¨¡å‹å¯èƒ½ä¸è¿”å› JSON
  const editModel = selectedModel.includes('reasoner') ? 'deepseek-chat' : selectedModel
  console.log('ğŸ“ ç¼–è¾‘æ¨¡å¼ä½¿ç”¨æ¨¡å‹:', editModel)
  
  await executeAIEdit({
    documentContent: plainTextContent,
    userRequest: userInput,
    model: editModel,  // ä½¿ç”¨ chat æ¨¡å‹
    // ...
  })
}
```

### æ–¹æ¡ˆ2ï¼šè°ƒæ•´ System Prompt

é’ˆå¯¹ reasoner æ¨¡å‹ä¼˜åŒ– system promptï¼Œæ˜ç¡®è¦æ±‚è¿”å› JSONï¼š

```typescript
const systemPrompt = model.includes('reasoner')
  ? `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æ¡£ç¼–è¾‘åŠ©æ‰‹ã€‚

ã€é‡è¦ã€‘è¯·å…ˆæ€è€ƒç”¨æˆ·çš„ä¿®æ”¹æ„å›¾ï¼Œç„¶åå¿…é¡»è¿”å› JSON æ ¼å¼çš„ä¿®æ”¹å»ºè®®ã€‚

æ€è€ƒå®Œæˆåï¼Œè¯·è¾“å‡ºï¼š
\`\`\`json
{
  "reasoning": "ä½ çš„åˆ†æ",
  "changes": [...]
}
\`\`\`

ä¸è¦åªè¾“å‡ºæ€è€ƒè¿‡ç¨‹ï¼Œå¿…é¡»åŒ…å«å®Œæ•´çš„ JSONã€‚`
  : // åŸæœ‰çš„ prompt
```

### æ–¹æ¡ˆ3ï¼šç­‰å¾… reasoner æ¨¡å‹å®Œæˆåå†è§£æ

ä¿®æ”¹æœåŠ¡ç«¯é€»è¾‘ï¼Œç­‰å¾…æ‰€æœ‰ chunk æ¥æ”¶å®Œæˆåå†è§£æï¼š

```typescript
// ç­‰å¾…æ‰€æœ‰ chunk
for await (const chunk of stream) {
  // ...
}

// æ‰€æœ‰ chunk æ¥æ”¶å®Œæˆåï¼Œå†è§£æ JSON
if (accumulatedContent.length > 0) {
  const result = parseJSON(accumulatedContent)
  // ...
}
```

## æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼ˆç¼–è¾‘æ¨¡å¼å¼ºåˆ¶ä½¿ç”¨ chat æ¨¡å‹ï¼‰** æ˜¯æœ€ç®€å•å¯é çš„æ–¹æ¡ˆï¼š

**ä¼˜ç‚¹ï¼š**
- å®ç°ç®€å•ï¼Œæ”¹åŠ¨æœ€å°
- ä¸å½±å“å…¶ä»–åŠŸèƒ½
- chat æ¨¡å‹åœ¨ç¼–è¾‘ä»»åŠ¡ä¸Šè¡¨ç°å·²ç»å¾ˆå¥½

**ç¼ºç‚¹ï¼š**
- ç¼–è¾‘æ¨¡å¼ä¸‹æ— æ³•ä½¿ç”¨æ·±åº¦æ€è€ƒ
- ä½†å®é™…ä¸Šç¼–è¾‘ä»»åŠ¡ä¸éœ€è¦æ·±åº¦æ€è€ƒ

## å®æ–½æ–¹æ¡ˆ1

ä¿®æ”¹ `client/src/components/editor/AIChatPanel/hooks/useChatLogic.ts`ï¼š

```typescript
// å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä¼˜å…ˆå¤„ç†ç¼–è¾‘é€»è¾‘ï¼Œä¸ç®¡ç”Ÿæˆæ¨¡å¼æ˜¯ä»€ä¹ˆ
if (isEditMode) {
  console.log('ğŸ”§ ç¼–è¾‘æ¨¡å¼ï¼šä¿®æ”¹ç°æœ‰å†…å®¹')
  
  // ç¼–è¾‘æ¨¡å¼ä¸‹å¼ºåˆ¶ä½¿ç”¨ chat æ¨¡å‹
  // å› ä¸º reasoner æ¨¡å‹åœ¨ç¼–è¾‘ä»»åŠ¡ä¸­å¯èƒ½ä¸è¿”å›æ­£ç¡®çš„ JSON æ ¼å¼
  const editModel = selectedModel.includes('reasoner') ? 'deepseek-chat' : selectedModel
  
  if (selectedModel.includes('reasoner')) {
    console.log('âš ï¸ ç¼–è¾‘æ¨¡å¼ä¸æ”¯æŒ reasoner æ¨¡å‹ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ° chat æ¨¡å‹')
  }
  
  setIsThinking(true)
  setIsGenerating(true)
  setHasStartedGenerating(false)
  onStreamingChange?.(true)

  const aiMessage: Message = {
    id: (Date.now() + 1).toString(),
    role: 'assistant',
    content: '',
    reasoning: '',
    timestamp: Date.now(),
    isStreaming: true,
    isGeneratingToEditor: false,
  }
  addMessage(aiMessage)

  let accumulatedContent = ''
  const plainTextContent = editor.getText()

  await executeAIEdit({
    documentContent: plainTextContent,
    userRequest: userInput,
    model: editModel,  // ä½¿ç”¨ chat æ¨¡å‹
    // ...
  })
  
  return
}
```

## åç»­ä¼˜åŒ–

å¦‚æœéœ€è¦åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ”¯æŒæ·±åº¦æ€è€ƒï¼Œéœ€è¦ï¼š

1. è°ƒè¯• reasoner æ¨¡å‹çš„è¿”å›æ ¼å¼
2. ä¼˜åŒ– system prompt
3. è°ƒæ•´ JSON è§£æé€»è¾‘
4. ç¡®ä¿ reasoner æ¨¡å‹èƒ½æ­£ç¡®è¿”å›ç»“æ„åŒ–æ•°æ®

ä½†ç›®å‰æ¥çœ‹ï¼Œç¼–è¾‘ä»»åŠ¡ä¸éœ€è¦æ·±åº¦æ€è€ƒï¼Œä½¿ç”¨ chat æ¨¡å‹å·²ç»è¶³å¤Ÿã€‚

## æµ‹è¯•è®¡åˆ’

å®æ–½æ–¹æ¡ˆ1åï¼Œæµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

1. **å¼€å¯æ·±åº¦æ€è€ƒ + ç¼–è¾‘**
   - å¼€å¯æ·±åº¦æ€è€ƒ
   - ç”Ÿæˆæ–‡æ¡£
   - è¾“å…¥"æŠŠæ ‡é¢˜æ”¹æˆxxx"
   - âœ… åº”è¯¥è‡ªåŠ¨åˆ‡æ¢åˆ° chat æ¨¡å‹å¹¶æˆåŠŸæ”¹å†™

2. **å…³é—­æ·±åº¦æ€è€ƒ + ç¼–è¾‘**
   - å…³é—­æ·±åº¦æ€è€ƒ
   - ç”Ÿæˆæ–‡æ¡£
   - è¾“å…¥"æŠŠæ ‡é¢˜æ”¹æˆxxx"
   - âœ… åº”è¯¥ä½¿ç”¨ chat æ¨¡å‹å¹¶æˆåŠŸæ”¹å†™

3. **å¼€å¯æ·±åº¦æ€è€ƒ + ç”Ÿæˆ**
   - å¼€å¯æ·±åº¦æ€è€ƒ
   - è¾“å…¥"å†™ä¸€ç¯‡æ–‡ç« "
   - âœ… åº”è¯¥ä½¿ç”¨ reasoner æ¨¡å‹å¹¶æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹

## æ€»ç»“

æ·±åº¦æ€è€ƒæ¨¡å¼ï¼ˆreasoner æ¨¡å‹ï¼‰åœ¨ç¼–è¾‘ä»»åŠ¡ä¸­å¯èƒ½ä¸è¿”å›æ­£ç¡®çš„ JSON æ ¼å¼ï¼Œå¯¼è‡´æ”¹å†™åŠŸèƒ½å¤±è´¥ã€‚

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼š** ç¼–è¾‘æ¨¡å¼ä¸‹å¼ºåˆ¶ä½¿ç”¨ chat æ¨¡å‹ï¼Œå› ä¸ºç¼–è¾‘ä»»åŠ¡ä¸éœ€è¦æ·±åº¦æ€è€ƒã€‚

**é•¿æœŸæ–¹æ¡ˆï¼š** å¦‚æœéœ€è¦æ”¯æŒï¼Œéœ€è¦è°ƒè¯• reasoner æ¨¡å‹çš„è¿”å›æ ¼å¼å¹¶ä¼˜åŒ–è§£æé€»è¾‘ã€‚
