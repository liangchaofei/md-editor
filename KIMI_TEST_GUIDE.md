# Kimi 模型测试指南

## 最新更新（2026-01-30）

✅ **新增功能：**
1. **深度思考开关** - 在输入框下方添加了"深度思考"按钮（类似 DeepSeek 官网）
2. **简化模型选择** - 移除了 DeepSeek Reasoner 选项，通过深度思考开关自动切换
3. **智能模型切换** - 启用深度思考时：
   - DeepSeek → 自动切换到 DeepSeek Reasoner
   - Kimi → 自动切换到 Kimi (128K) 最大上下文版本

## 当前状态

✅ **已完成：**
1. 前端模型选择器（DeepSeek / Kimi 8K/32K/128K）
2. 深度思考开关（输入框下方）
3. 后端 API 自动路由（根据模型选择 API 端点）
4. 类型定义修复（支持上下文定位）
5. 环境变量配置示例

⚠️ **待完成：**
1. 添加 Kimi API Key 到 `.env` 文件
2. 测试 Kimi 模型的 AI 对话式编辑功能

---

## 第一步：配置 Kimi API Key

### 1. 获取 API Key

访问 [Kimi 开放平台](https://platform.moonshot.cn/)：
1. 注册/登录账号
2. 进入控制台
3. 创建 API Key
4. 复制 API Key（格式：`sk-xxx...`）

### 2. 添加到环境变量

编辑 `server/.env` 文件，添加：

```env
# Kimi (Moonshot) API 配置
MOONSHOT_API_KEY=sk-你的API密钥
```

完整的 `.env` 文件应该是：

```env
# DeepSeek API 配置
DEEPSEEK_API_KEY=sk-3fd17d063ad1412493ccc23077d20142
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat

# Kimi (Moonshot) API 配置
MOONSHOT_API_KEY=sk-你的API密钥
```

### 3. 重启服务器

```bash
cd server
pnpm dev
```

---

## 第二步：测试 Kimi 模型

### 测试场景 1：深度思考功能（新增）

**目的：** 验证深度思考开关是否正常工作

**步骤：**
1. 打开编辑器
2. 点击右侧 AI 助手面板
3. 选择模型 **"DeepSeek"**
4. 点击输入框下方的 **"深度思考"** 按钮（应该变成紫色高亮）
5. 输入：`请详细分析前端开发的学习路径`
6. 点击发送

**预期结果：**
- 提示显示 "将使用 DeepSeek Reasoner"
- AI 会显示详细的思考过程（紫色背景）
- 思考完成后生成内容

**对比测试：**
1. 关闭深度思考开关
2. 输入相同问题
3. 对比响应速度和内容质量

---

### 测试场景 2：简单对话（验证 API 连接）

**目的：** 验证 Kimi API Key 是否正确配置

**步骤：**
1. 打开编辑器
2. 点击右侧 AI 助手面板
3. 在顶部模型选择器选择 **"Kimi (8K)"**
4. 输入：`你好，请介绍一下自己`
5. 点击发送

**预期结果：**
- Kimi 会介绍自己是 Moonshot AI 的产品
- 回复流畅，无错误

**如果失败：**
- 检查 API Key 是否正确
- 查看服务器日志是否有错误
- 确认网络能访问 `api.moonshot.cn`

---

### 测试场景 3：AI 对话式编辑（核心功能）

**目的：** 测试 Kimi 是否能准确理解用户意图并定位文本

#### 测试 3.1：修改标题（启用深度思考）

**步骤：**
1. 在编辑器中输入以下内容（或使用 AI 生成）：

```
# 前端开发系统学习计划（6-9个月）

## 第一阶段：基础入门（1-2个月）

**目标：** 掌握Web三件套，能制作简单静态页面

**学习内容：**

### HTML5（1周）
- 语义化标签
- 表单、多媒体元素
- 基础SEO知识

### CSS3（2-3周）
- 盒模型、定位、浮动
- Flex布局、Grid布局
- 响应式设计
- CSS动画与过渡

### JavaScript基础（3-4周）
- 变量、数据类型、运算符
- 流程控制、函数、作用域
- DOM操作、事件处理
- ES6+基础语法（let/const、箭头函数、解构等）

## 第二阶段：核心技能深化（2-3个月）

**目标：** 掌握现代前端框架，理解工程化

**学习内容：**

### JavaScript高级（2周）
- 原型与继承
- 异步编程（Promise、async/await）
- 模块化
- 常用API（Array、String方法）
```

2. 在 AI 对话框中选择 **"Kimi (32K)"**
3. **启用深度思考开关**（点击输入框下方的"深度思考"按钮）
4. 输入：`把基础入门改为零基础入门学习`
5. 点击发送

**预期结果：**
- 显示 "将使用最大上下文模型"（自动切换到 Kimi 128K）
- AI 思考过程中会详细分析用户意图
- 返回 JSON 格式的修改建议
- **只返回一个修改**（第一阶段的标题）
- 编辑器中 "基础入门" 被蓝色高亮标记
- Hover 显示 tooltip（接受/拒绝按钮）

**关键检查点：**
- ✅ 只标记了 "第一阶段：基础入门" 中的 "基础入门"
- ❌ 没有标记其他地方的 "基础" 或 "入门"

**如果失败（标记了多个位置）：**
- 查看浏览器控制台的日志
- 检查 AI 返回的 JSON 数据
- 确认 `changes` 数组只有一个元素

---

#### 测试 3.2：修改具体章节

**步骤：**
1. 使用上面的文档
2. 在 AI 对话框中输入：`把第二阶段的标题改为"进阶技能提升"`
3. 点击发送

**预期结果：**
- AI 准确定位到 "第二阶段：核心技能深化"
- 只标记 "核心技能深化" 这几个字
- 替换建议为 "进阶技能提升"

---

#### 测试 3.3：修改正文内容

**步骤：**
1. 使用上面的文档
2. 在 AI 对话框中输入：`把 HTML5 的学习时间从1周改为2周`
3. 点击发送

**预期结果：**
- AI 准确定位到 "HTML5（1周）"
- 只标记 "1周"
- 替换建议为 "2周"

---

### 测试场景 4：对比 DeepSeek 和 Kimi

**目的：** 对比两个模型的理解能力

**步骤：**
1. 使用相同的文档和相同的修改请求
2. 先用 **DeepSeek + 深度思考** 测试
3. 再用 **Kimi (32K) + 深度思考** 测试
4. 对比结果

**对比维度：**
- 定位准确性（是否只返回一个修改）
- 理解能力（是否理解用户真实意图）
- 响应速度
- 思考过程质量

---

## 第三步：UI 说明

### 深度思考开关

位置：输入框下方

**外观：**
- 未启用：白色背景，灰色边框，灰色文字
- 已启用：紫色背景，紫色边框，紫色文字 + 勾选图标

**功能：**
- 点击切换开关状态
- 启用后会显示提示文字：
  - DeepSeek: "将使用 DeepSeek Reasoner"
  - Kimi: "将使用最大上下文模型"

**效果：**
- DeepSeek: 自动切换到 `deepseek-reasoner` 模型
- Kimi: 自动切换到 `moonshot-v1-128k` 模型

### 模型选择器

位置：AI 面板顶部右侧

**选项：**
- DeepSeek（默认）
- Kimi (8K) - 适合短文本
- Kimi (32K) - 适合中等长度文本
- Kimi (128K) - 适合长文本

**注意：** 不再显示 "DeepSeek Reasoner" 选项，通过深度思考开关自动切换

---

## 第四步：调试技巧

### 1. 查看浏览器控制台

按 F12 打开开发者工具，查看：
- AI 返回的原始数据
- 文本匹配过程
- 错误信息

关键日志：
```
🔧 编辑模式：修改现有内容
📄 发送给 AI 的纯文本内容（前500字符）: ...
📝 收到结构化修改建议: ...
🎯 第一个修改建议:
  - contextBefore: ...
  - targetText: ...
  - contextAfter: ...
  - replacement: ...
```

### 2. 使用调试按钮

AI 对话面板顶部有一个 "ℹ️" 调试按钮：
- 点击后会打印当前文档内容到控制台
- 可以验证 AI 收到的内容是否正确

### 3. 查看服务器日志

在 `server` 目录下运行 `pnpm dev`，查看：
- AI API 请求日志
- JSON 解析过程
- 错误信息

关键日志：
```
🤖 开始 AI 请求: { model: 'moonshot-v1-32k', ... }
🌙 使用 Kimi API
🔍 尝试解析 AI 返回内容
✅ JSON 解析成功
📊 找到 1 个修改建议
```

---

## 第五步：问题排查

### 问题 1：Kimi 模型无响应

**可能原因：**
- API Key 未配置或错误
- 网络无法访问 Kimi API
- 服务器未重启

**解决方法：**
1. 检查 `server/.env` 中的 `MOONSHOT_API_KEY`
2. 测试网络：`curl https://api.moonshot.cn/v1/models`
3. 重启服务器：`cd server && pnpm dev`

---

### 问题 2：401 错误（未授权）

**原因：** API Key 无效

**解决方法：**
1. 登录 [Kimi 平台](https://platform.moonshot.cn/)
2. 检查 API Key 是否有效
3. 重新生成 API Key
4. 更新 `.env` 文件
5. 重启服务器

---

### 问题 3：仍然匹配到多个位置

**可能原因：**
- AI 模型理解能力不足
- Prompt 需要优化
- 文档内容过于相似

**解决方法：**

#### 方法 1：优化用户输入
更明确地描述位置：
- ❌ "把基础入门改为零基础入门学习"
- ✅ "把第一阶段的标题'基础入门'改为'零基础入门学习'"

#### 方法 2：检查前端过滤
在 `client/src/components/editor/TiptapEditor.tsx` 中，确认有前端过滤：

```typescript
// 只取第一个修改（前端保险）
const firstChange = response.changes[0]
if (firstChange) {
  const targetText = firstChange.targetText || firstChange.target || ''
  // ...
}
```

#### 方法 3：优化后端 Prompt
编辑 `server/src/routes/ai.ts`，在 systemPrompt 中强调：
- "只返回用户真正想修改的那一个位置"
- "标题、章节名优先于正文中的普通词汇"

---

### 问题 4：上下文定位失败

**症状：** 控制台显示 "❌ 无法在文档中找到匹配文本"

**可能原因：**
- AI 返回的 `contextBefore/After` 不准确
- 文档内容与 AI 理解的不一致

**解决方法：**
1. 查看控制台日志，对比：
   - AI 返回的 `targetText`
   - 文档中的实际文本
2. 检查是否有特殊字符、空格差异
3. 使用调试按钮打印文档内容

---

## 第六步：性能对比

测试完成后，填写对比表格：

| 维度 | DeepSeek | DeepSeek + 深度思考 | Kimi (32K) | Kimi (32K) + 深度思考 | 备注 |
|------|----------|---------------------|------------|----------------------|------|
| 定位准确性 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Kimi 更准确 |
| 理解能力 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | Kimi 理解更好 |
| 响应速度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | DeepSeek 更快 |
| 思考质量 | - | ⭐⭐⭐⭐ | - | ⭐⭐⭐⭐ | 深度思考更详细 |
| 成本 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | DeepSeek 更便宜 |

---

## 第七步：下一步计划

### 如果 Kimi 效果好：
1. ✅ 将 Kimi 设为默认模型（编辑模式）
2. ✅ 继续优化 Prompt
3. ✅ 添加更多测试用例
4. ✅ 完成 Chapter 24 文档

### 如果 Kimi 效果仍不理想：
1. 考虑简化功能：
   - 方案 A：要求用户先选中文本，再描述修改
   - 方案 B：使用多轮对话确认位置
   - 方案 C：显示多个候选位置，让用户选择
2. 尝试其他模型（GPT-4、Claude）
3. 优化匹配算法（前端智能匹配）

---

## 附录：完整测试清单

- [ ] 配置 Kimi API Key
- [ ] 重启服务器
- [ ] 测试 1：深度思考功能
- [ ] 测试 2：简单对话（验证连接）
- [ ] 测试 3.1：修改标题（启用深度思考）
- [ ] 测试 3.2：修改具体章节
- [ ] 测试 3.3：修改正文内容
- [ ] 测试 4：对比 DeepSeek 和 Kimi（都启用深度思考）
- [ ] 填写性能对比表格
- [ ] 决定下一步方案

---

## 相关文件

- `server/.env` - 环境变量配置
- `server/src/services/ai.ts` - AI 服务（模型路由）
- `server/src/routes/ai.ts` - AI 路由（Prompt）
- `client/src/components/editor/AIChatPanel.tsx` - AI 对话面板
- `client/src/hooks/useSuggestions.ts` - 建议管理
- `client/src/utils/textMatcher.ts` - 文本匹配算法

---

**祝测试顺利！如果遇到问题，请查看浏览器控制台和服务器日志。**
