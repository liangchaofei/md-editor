# Chapter 27 测试指南

## 测试准备

### 1. 启动服务
```bash
# 终端 1：启动后端
cd server
pnpm dev

# 终端 2：启动前端
cd client
pnpm dev
```

### 2. 准备测试文档

在编辑器中创建一个新文档，输入以下内容：

```markdown
# 项目介绍

这是一个企业级协同编辑器项目。

## 技术栈介绍

本项目使用以下技术栈：
- 前端：React 18 + TypeScript + Vite
- 后端：Node.js + Koa2
- 数据库：SQLite

## 功能特性

1. 实时协同编辑
2. AI 写作助手
3. 版本历史管理

## 第一阶段：基础入门（1-2个月）

学习基础知识，掌握核心技术。

## 第二阶段：进阶学习（2-3个月）

深入学习高级特性。
```

---

## 测试用例

### 测试 1：修改标题

**输入**：
```
把技术栈介绍改为技术架构说明
```

**预期结果**：
1. AI 思考过程显示在右侧对话面板
2. 编辑器中"技术栈介绍"显示删除线
3. "技术架构说明"显示绿色高亮
4. Hover 到绿色文本时显示 Tooltip
5. Tooltip 包含"接受"和"拒绝"按钮

**验证步骤**：
1. 在 AI 对话框输入上述文本
2. 点击"发送"
3. 观察 AI 思考过程
4. 观察编辑器中的 diff 效果
5. Hover 到绿色文本
6. 点击"接受"按钮
7. 验证只保留新文本

---

### 测试 2：修改正文内容

**输入**：
```
把 React 18 改为 React 19
```

**预期结果**：
1. 正确定位到"React 18"
2. 显示 diff 效果：~~React 18~~ React 19
3. Hover 显示 Tooltip

**验证步骤**：
1. 输入上述文本
2. 观察定位是否准确
3. 测试接受/拒绝功能

---

### 测试 3：修改章节标题

**输入**：
```
把第一阶段的标题改为零基础入门学习
```

**预期结果**：
1. AI 理解"第一阶段"指的是"基础入门"
2. 正确定位到"基础入门"
3. 显示 diff 效果

**验证步骤**：
1. 输入上述文本
2. 验证 AI 是否理解意图
3. 验证定位是否准确

---

### 测试 4：拒绝修改

**输入**：
```
把实时协同编辑改为多人协作编辑
```

**操作**：
1. 等待 AI 返回建议
2. Hover 到绿色文本
3. 点击"拒绝"按钮

**预期结果**：
1. 删除线和高亮消失
2. 只保留原文"实时协同编辑"
3. Tooltip 消失

---

### 测试 5：错误处理

**输入**：
```
把不存在的文本改为其他内容
```

**预期结果**：
1. AI 返回错误提示
2. 或者 AI 说明无法找到该文本
3. 不会在编辑器中添加任何标记

---

## 调试技巧

### 1. 查看控制台日志

打开浏览器开发者工具（F12），查看 Console 标签：

```javascript
// 文本定位日志
🔍 文本定位调试
📄 文档长度: 500
🎯 目标文本: "技术栈介绍"
✅ 策略1: 精确匹配成功
   位置: { from: 45, to: 50 }

// AI 返回数据日志
📥 收到数据: { type: 'structured', content: {...} }
📝 收到 structured 数据
📊 找到 1 个修改建议
```

### 2. 检查网络请求

在 Network 标签中查看 `/api/ai/edit` 请求：
- 请求体：documentContent, userRequest
- 响应：SSE 流式数据

### 3. 检查 DOM 元素

在 Elements 标签中查找：
```html
<span data-suggestion-id="suggestion-xxx" class="suggestion-mark">
  新文本
</span>
```

### 4. 常见问题排查

**问题 1：无法定位到文本**
- 检查 `editor.getText()` 返回的内容
- 检查 AI 返回的 targetText 是否与文档一致
- 查看控制台的匹配策略日志

**问题 2：Tooltip 不显示**
- 检查 DOM 中是否有 `data-suggestion-id` 属性
- 检查 CSS 样式是否正确
- 检查 z-index 是否被遮挡

**问题 3：接受/拒绝后内容错误**
- 检查 suggestion.from 和 suggestion.to 是否正确
- 检查 replacement 长度是否正确
- 查看控制台的操作日志

---

## 性能测试

### 1. 匹配速度

测试不同长度文档的匹配速度：
- 短文档（< 1000 字）：应该 < 10ms
- 中文档（1000-5000 字）：应该 < 50ms
- 长文档（> 5000 字）：应该 < 200ms

### 2. 内存占用

打开 Performance Monitor：
- 添加建议前后的内存变化
- 多次操作后是否有内存泄漏

### 3. 渲染性能

使用 Performance 标签录制：
- 添加建议的渲染时间
- Hover 显示 Tooltip 的响应时间
- 接受/拒绝操作的执行时间

---

## 已知限制

1. **单次只支持一个修改**
   - 当前实现每次只处理一个修改建议
   - 如果需要多处修改，需要多次操作

2. **文本必须存在于文档中**
   - AI 返回的 targetText 必须能在文档中找到
   - 如果文本不存在，会显示错误

3. **不支持跨段落修改**
   - 当前只支持单个文本片段的修改
   - 不支持修改多个段落

4. **Tooltip 定位可能不准确**
   - 在滚动后可能需要重新计算位置
   - 在窗口 resize 后可能需要调整

---

## 下一步优化

1. **支持多处修改**
   - 一次返回多个建议
   - 批量接受/拒绝

2. **改进定位算法**
   - 支持正则表达式匹配
   - 支持语义理解

3. **增强 Tooltip**
   - 显示修改预览
   - 支持编辑建议
   - 添加快捷键

4. **添加动画效果**
   - 添加建议时的淡入动画
   - 接受/拒绝时的过渡动画

---

## 测试检查清单

- [ ] AI 能正确理解用户意图
- [ ] 文本定位准确无误
- [ ] Diff 效果显示正确（删除线 + 绿色高亮）
- [ ] Hover 时 Tooltip 正确显示
- [ ] 接受修改功能正常
- [ ] 拒绝修改功能正常
- [ ] 错误处理完善
- [ ] 控制台无错误日志
- [ ] 性能表现良好
- [ ] 多次操作无内存泄漏

---

## 反馈

如果发现问题，请记录：
1. 操作步骤
2. 预期结果
3. 实际结果
4. 控制台日志
5. 网络请求详情

这将帮助快速定位和修复问题。
